{"version":3,"sources":["api/token.ts","api/candles.ts","api/instruments.ts","api/operations.ts","tools/currencies.ts","tools/instruments.ts","tools/react.ts","widgets/currenciesSwitch.tsx","widgets/daysSwitch.tsx","widgets/spans.tsx","widgets/graph.tsx","blocks/history.tsx","blocks/loginForm.tsx","widgets/dateRangeSelector.tsx","tools/operations.ts","widgets/instrument.tsx","tools/lang.ts","blocks/portfolio.tsx","blocks/topPanel.tsx","stats/stats.ts","App.tsx","serviceWorker.ts","index.tsx"],"names":["apiToken","localStorage","getItem","loadCandles","figi","from","a","urlParams","toISOString","Date","fetch","headers","accept","Authorization","resp","json","data","payload","candles","findPrice","date","index","lowBorder","highBorder","length","low","high","time","middle","middleDate","findCandleIndex","undefined","c","lastPrice","Error","load","type","instruments","loadInstruments","stocksCall","bondsCall","etfsCall","currenciesCall","stocks","bonds","etfs","currencies","map","b","i","m","forEach","loadOps","url","URL","searchParams","set","toString","ops","operations","sort","o1","o2","d1","d2","toRub","currency","amount","usdPrice","eurPrice","toUsd","toEur","toCur","fromCur","CurrenciesCalc","usdCost","eurCost","rubTotal","this","rub","usd","eur","sortInstruments","states","infos","Object","values","Math","abs","price","aTicker","ticker","bTicker","localeCompare","base","classes","push","cl","conds","join","CurrenciesSwitch","cur","props","className","onClick","onCurSwitch","React","Component","DaysSwitch","drawAllTime","drawDay1","drawDay7","drawDay30","setFlags","fNum","v","round","toLocaleString","Rub","cls","color","Usd","Eur","Cur","t","Prc","formatYear","d","getFullYear","formatMonth","getMonth","formatDate","getDate","formatHour","h","getHours","dateFormatSpecs","timeGap","regularFormat","yearGapFormat","monthGapFormat","dayGapFormat","DateTime","fromJSDate","toFormat","formatDateVals","self","splits","gap","ceil","s","find","e","prevY","prevM","prevDate","ts","y","diffY","diffM","diffDate","formatValShort","val","toFixed","curSign","RUB","USD","EUR","digits","roundDigits","Graph","uplot","el","interval","resizeListener","setSize","width","clientWidth","height","window","addEventListener","setupUPlot","setInterval","syncRect","destroy","s1","s2","s3","s4","timestamps","seriesOpts","value","_","valType","series","label","timestamp","stroke","fill","opts","fmtDate","axes","uPlot","removeEventListener","clearInterval","ref","calcTotalRub","dayState","total","portfolio","calcTotalOwnRub","ownRub","ownUsd","ownEur","HistoryBlock","state","expandedDays","Set","dayStates","dayStats","dayState1","max","dayState7","dayState30","totalCur","totalOwnCur","totalCur1","totalCur7","totalCur30","added1","added7","added30","performance","performance1","performance7","performance30","getTime","reverseDayStates","reverse","slice","reverseDayStats","perfLabel","perfData","setState","d7","d30","renderDayStats","dayStat","expanded","has","available","addRub","addUsd","addEur","own","key","toISODate","filter","renderInstrument","flipExpandedDay","icon","faAngleUp","faAngleDown","op","renderOp","instrument","info","opJson","JSON","stringify","ed","delete","add","LoginForm","token","onChange","ev","target","placeholder","autoFocus","onLoginClick","setItem","onLoggedIn","DateRangeSelector","chartDiv","clientHeight","class","cursor","show","legend","scales","x","setData","diff","min","as","startPos","start","endPos","end","dateFormat","selected","toJSDate","posToDate","position","plus","Duration","fromObject","days","timeline","opQuantity","trades","quantity","reduce","p","Instrument","initDay","curDay","instrumentInfo","initialInstrumentState","initialInstrumentCost","effect","startDt","fromMillis","fromISO","operationType","startsWith","q","payment","n","form0","form1","form2","op1","result","name","renderAllCurrenciesColumns","colSpan","faChevronUp","renderEmptyAllCurrenciesColumns","renderOperation","is","faChevronDown","opName","faAngleRight","faWallet","id","faCoins","PortfolioBlock","startPosition","endPosition","expandedInstruments","initial","current","initialTotal","currentTotal","initialOwn","addedUsd","minDate","maxDate","startDate","endDate","dateToPos","renderOwnMoney","renderAvailable","availLine","ownMoneyLine","toLowerCase","totalOwn","TopPanelBlock","activeTab","onTabClick","onLogoutClick","loading","faSpinner","pulse","onReloadClick","NoFigiOps","EUR_FIGI","USD_FIGI","nextDay","setHours","setDate","Stats","figiMap","instrumentsMap","Map","console","log","stats","opIndex","startDay","nd","status","deepCopy","App","loadData","forceUpdate","lastDay","topPanel","tab","removeItem","cPromises","candlesLoadFrom","minus","hours","allInstruments","Promise","all","Boolean","location","hostname","match","ReactDOM","render","document","getElementById","navigator","serviceWorker","ready","then","registration","unregister","catch","error","message"],"mappings":"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","file":"static/js/main.00c81686.chunk.js","sourcesContent":["const API_TOKEN_KEY = \"API_TOKEN\";\n\nexport function apiToken (): string | null {\n  return localStorage.getItem(API_TOKEN_KEY);\n}\n\nexport function clearApiToken (): void {\n  localStorage.removeItem(API_TOKEN_KEY);\n}\n\nexport function setApiToken (token: string): void {\n  localStorage.setItem(API_TOKEN_KEY, token);\n}\n\n// Токен отозван ;)\n// t._BX5KYSF1XAQtyxgXM3ZSQtjXwfDdDilN3sR9onivsGhrQ6N2tt-GGrcP7kLxy_fTVqN9Xk01qOjXC0qb_wp7g\n","import { apiToken } from \"./token\";\n\nexport interface Candle {\n  o: number;\n  c: number;\n  h: number;\n  l: number;\n  v: number;\n  time: string;\n  interval: string;\n}\n\nexport async function loadCandles (figi: string, from: Date): Promise<Candle[]> {\n  const urlParams = `figi=${figi}&from=${from.toISOString()}&to=${new Date().toISOString()}&interval=day`;\n  const resp = await fetch(\n    `https://api-invest.tinkoff.ru/openapi/market/candles?${urlParams}`,\n    {\n      headers: {\n        accept: 'application/json',\n        Authorization:\n          `Bearer ${apiToken()}`\n      }\n    }\n  );\n  const data = await resp.json();\n  return data.payload.candles;\n}\n\nexport function findCandleIndex (\n  candles: Candle[], date: Date, lowBorder?: number, highBorder?: number\n): number | undefined {\n  if (candles.length === 0) return;\n\n  let low = lowBorder ?? 0;\n  let high = highBorder ?? candles.length - 1;\n\n  if (date < new Date(candles[low].time))\n    return;\n  if (new Date(candles[high].time) <= date) return high;\n\n  while (true) {\n    if (high - low < 2) return low;\n    const middle = low + ((high - low) / 2 | 0);\n    const middleDate = new Date(candles[middle].time);\n    if (middleDate < date) {\n      low = middle;\n    } else if (middleDate > date) {\n      high = middle;\n    } else {\n      return middle;\n    }\n  }\n}\n\nexport function findPrice (candles: Candle[], date: Date): number | undefined {\n  const index = findCandleIndex(candles, date);\n  if (index === undefined) {\n    return;\n  }\n  return candles[index].c;\n}\n\nexport function lastPrice (candles: Candle[]): number {\n  if (candles.length === 0) {\n    throw Error(\"No candles\");\n  }\n\n  return candles[candles.length - 1].c;\n}\n","import { Currency, InstrumentType, OkResponse } from './common';\nimport { apiToken } from './token';\n\ninterface StocksResponse extends OkResponse {\n  payload: {\n    instruments: Instrument[];\n    total: number;\n  };\n}\n\nexport interface Instrument {\n  figi: string;\n  ticker: string;\n  isin?: string;\n  minPriceIncrement?: number;\n  lot?: number;\n  currency?: Currency;\n  name: string;\n  type: InstrumentType;\n}\n\nexport interface InstrumentsMap {\n  [figi: string]: Instrument | undefined;\n}\n\nasync function load (type: string): Promise<Instrument[]> {\n  const resp = await fetch(`https://api-invest.tinkoff.ru/openapi/market/${type}`, {\n    headers: {\n      accept: 'application/json',\n      Authorization:\n        `Bearer ${apiToken()}`\n    }\n  });\n  const data = await resp.json() as StocksResponse;\n  return data.payload.instruments;\n}\n\nexport async function loadInstruments (): Promise<InstrumentsMap> {\n  const stocksCall = load(\"stocks\");\n  const bondsCall = load(\"bonds\");\n  const etfsCall = load(\"etfs\");\n  const currenciesCall = load(\"currencies\");\n\n  const stocks = await stocksCall;\n  const bonds = await bondsCall;\n  const etfs = await etfsCall;\n  const currencies = await currenciesCall;\n\n  // fixes of returning values\n  const instruments = [\n    ...stocks,\n    ...bonds.map(b => { b.type = \"Bond\"; return b; }),\n    ...etfs.map(i => { i.type = \"Etf\"; return i; }),\n    ...currencies.map(i => { i.type = \"Currency\"; return i; }),\n  ];\n\n  const m: InstrumentsMap = {};\n  instruments.forEach(i => {\n    m[i.figi] = i;\n  });\n  return m;\n}\n","import { OkResponse, Operation } from './common';\nimport { apiToken } from './token';\n\ninterface OpsResponse extends OkResponse {\n  payload: {\n    operations: Operation[];\n    total: number;\n  };\n}\n\nexport async function loadOps (): Promise<Operation[]> {\n  const url = new URL('/openapi/operations', 'https://api-invest.tinkoff.ru');\n  url.searchParams.set('from', '1900-01-01T00:00:00Z');\n  url.searchParams.set('to', new Date().toISOString());\n  const resp = await fetch(url.toString(), {\n    headers: {\n      accept: 'application/json',\n      Authorization:\n        `Bearer ${apiToken()}`\n    }\n  });\n  const data = await resp.json() as OpsResponse;\n\n  const ops = data.payload.operations;\n\n  ops.sort((o1, o2) => {\n    const d1 = new Date(o1.date);\n    const d2 = new Date(o2.date);\n    if (d1 > d2) {\n      return 1;\n    }\n    if (d1 < d2) {\n      return -1;\n    }\n    return 0;\n  });\n\n  return ops;\n}\n","import { Currency } from '../api/common';\n\nexport function toRub (currency: Currency, amount: number, usdPrice: number, eurPrice: number): number {\n  if (currency === \"RUB\") {\n    return amount;\n  }\n\n  if (currency === \"USD\") {\n    return amount * usdPrice;\n  }\n\n  if (currency === \"EUR\") {\n    return amount * eurPrice;\n  }\n\n  throw Error(\"Unknown currency\");\n}\n\nexport function toUsd (currency: Currency, amount: number, usdPrice: number, eurPrice: number): number {\n  if (currency === \"RUB\") {\n    return amount / usdPrice;\n  }\n\n  if (currency === \"USD\") {\n    return amount;\n  }\n\n  if (currency === \"EUR\") {\n    return (amount * eurPrice) / usdPrice;\n  }\n\n  throw Error(\"Unknown currency\");\n}\n\nexport function toEur (currency: Currency, amount: number, usdPrice: number, eurPrice: number): number {\n  if (currency === \"RUB\") {\n    return amount / eurPrice;\n  }\n\n  if (currency === \"USD\") {\n    return (amount * usdPrice) / eurPrice;\n  }\n\n  if (currency === \"EUR\") {\n    return amount;\n  }\n\n  throw Error(\"Unknown currency\");\n}\n\nexport function toCur (toCur: Currency, fromCur: Currency, amount: number, usdPrice: number, eurPrice: number): number {\n  if (toCur === \"RUB\") return toRub(fromCur, amount, usdPrice, eurPrice);\n  if (toCur === \"USD\") return toUsd(fromCur, amount, usdPrice, eurPrice);\n  return toEur(fromCur, amount, usdPrice, eurPrice);\n}\n\nexport class CurrenciesCalc {\n  private usdCost: number\n  private eurCost: number\n\n  private rubTotal = 0\n\n  constructor(usdPrice: number, eurPrice: number) {\n    this.usdCost = usdPrice;\n    this.eurCost = eurPrice;\n  }\n\n  add (currency: Currency, amount: number): CurrenciesCalc {\n    if (currency === \"RUB\") this.rubTotal += amount;\n    if (currency === \"USD\") this.rubTotal += amount * this.usdCost;\n    if (currency === \"EUR\") this.rubTotal += amount * this.eurCost;\n    return this;\n  }\n\n  addRub (amount: number): CurrenciesCalc {\n    this.rubTotal += amount;\n    return this;\n  }\n\n  addUsd (amount: number): CurrenciesCalc {\n    this.rubTotal += amount * this.usdCost;\n    return this;\n  }\n\n  addEur (amount: number): CurrenciesCalc {\n    this.rubTotal += amount * this.eurCost;\n    return this;\n  }\n\n  rub (): number {\n    return this.rubTotal;\n  }\n\n  usd (): number {\n    return this.rubTotal / this.usdCost;\n  }\n\n  eur (): number {\n    return this.rubTotal / this.eurCost;\n  }\n\n  cur (c: Currency): number {\n    if (c === \"RUB\") return this.rub();\n    if (c === \"USD\") return this.usd();\n    return this.eur();\n  }\n}\n","import { InstrumentsMap } from \"../api/instruments\";\nimport { InstrumentState } from \"../stats/instrumentState\";\nimport { toRub } from \"./currencies\";\n\nexport function sortInstruments (\n  states: { [figi: string]: InstrumentState },\n  infos: InstrumentsMap,\n  usdPrice: number,\n  eurPrice: number\n): InstrumentState[] {\n  return Object.values(states)\n    .sort((a, b) => {\n      const c = (\n        Math.abs(toRub(b.currency, b.amount * b.price, usdPrice, eurPrice))\n        - Math.abs(toRub(a.currency, a.amount * a.price, usdPrice, eurPrice))\n      );\n      if (c !== 0) return c;\n      const aTicker = infos[a.figi]?.ticker;\n      const bTicker = infos[b.figi]?.ticker;\n      if (aTicker === undefined || bTicker === undefined) {\n        throw Error(\"Unknown instruments\");\n      }\n      return aTicker.localeCompare(bTicker);\n    });\n}\n","export function c (base: string | Iterable<string>, ...conds: [boolean, string][]): string {\n  const classes: string[] = [];\n\n  if (typeof base === \"string\") {\n    classes.push(base);\n  } else {\n    for (const cl of base) {\n      classes.push(cl);\n    }\n  }\n\n  for (const c of conds) {\n    if (c[0]) {\n      classes.push(c[1]);\n    }\n  }\n\n  return classes.join(\" \");\n}","import React from \"react\";\nimport { Currency } from '../api/common';\nimport { c } from \"../tools/react\";\nimport \"./currenciesSwitch.scss\";\n\ninterface P {\n  currency: Currency;\n  onCurSwitch: (currebcy: Currency) => void;\n}\n\nexport class CurrenciesSwitch extends React.Component<P> {\n  render (): JSX.Element {\n    const cur = this.props.currency;\n\n    return (\n      <div className='cCurrenciesSwitch'>\n        <div\n          className={c(\"\", [cur === \"RUB\", \"active\"])}\n          onClick={(): void => this.props.onCurSwitch(\"RUB\")}\n        >\n          в Рублях\n        </div>\n        <div\n          className={c(\"\", [cur === \"USD\", \"active\"])}\n          onClick={(): void => this.props.onCurSwitch(\"USD\")}\n        >\n          в Долларах\n        </div>\n        <div\n          className={c(\"\", [cur === \"EUR\", \"active\"])}\n          onClick={(): void => this.props.onCurSwitch(\"EUR\")}\n        >\n          в Евро\n        </div>\n      </div>\n    );\n  }\n}","import React from \"react\";\nimport { c } from \"../tools/react\";\nimport \"./daysSwitch.scss\";\n\ninterface P {\n  drawAllTime: boolean;\n  drawDay1: boolean;\n  drawDay7: boolean;\n  drawDay30: boolean;\n\n  setFlags: (drawAllTime: boolean, drawDay1: boolean, drawDay7: boolean, drawDay30: boolean) => void;\n}\n\nexport class DaysSwitch extends React.Component<P> {\n  render (): JSX.Element {\n    const { drawAllTime, drawDay1, drawDay7, drawDay30, setFlags } = this.props;\n\n    return (\n      <div className='cDaysSwitch'>\n        <div\n          className={c(\"all-time-switch\", [drawAllTime, \"active\"])}\n          onClick={(): void => setFlags(!drawAllTime, drawDay1, drawDay7, drawDay30)}\n        >\n          <div className={c(\"all-time-mark\", [drawAllTime, \"active\"])} />\n          за все время\n        </div>\n        <div className='radio-switch'>\n          <div\n            className={c(\"\", [drawDay1, \"active\"])}\n            onClick={(): void => setFlags(drawAllTime, true, false, false)}\n          >\n            за день\n          </div>\n          <div\n            className={c(\"\", [drawDay7, \"active\"])}\n            onClick={(): void => setFlags(drawAllTime, false, true, false)}\n          >\n            за 7 дней\n          </div>\n          <div\n            className={c(\"\", [drawDay30, \"active\"])}\n            onClick={(): void => setFlags(drawAllTime, false, false, true)}\n          >\n            за 30 дней\n          </div>\n        </div>\n      </div>\n    );\n  }\n}","import React from 'react';\nimport { Currency } from '../api/common';\nimport { c } from '../tools/react';\nimport \"./spans.scss\";\n\nexport function fNum (v: number): string {\n  return (Math.round(v * 100) / 100).toLocaleString(\"ru-RU\");\n}\n\nexport const Rub = (props: { v: number; color?: boolean }): JSX.Element => {\n  const cls = c('currency rub', [props.v > 0, \"positive\"], [props.v < 0, \"negative\"], [props.color === true, \"color\"]);\n  return <span className={cls}>{'\\u20BD'} {fNum(props.v)}</span>;\n};\n\nexport const Usd = (props: { v: number; color?: boolean }): JSX.Element => {\n  const cls = c('currency usd', [props.v > 0, \"positive\"], [props.v < 0, \"negative\"], [props.color === true, \"color\"]);\n  return <span className={cls}>$ {fNum(props.v)}</span>;\n};\n\nexport const Eur = (props: { v: number; color?: boolean }): JSX.Element => {\n  const cls = c('currency eur', [props.v > 0, \"positive\"], [props.v < 0, \"negative\"], [props.color === true, \"color\"]);\n  return <span className={cls}>{'\\u20AC'} {fNum(props.v)}</span>;\n};\n\nexport const Cur = (props: { t: Currency; v: number; color?: boolean }): JSX.Element => {\n  const { t, v } = props;\n\n  if (t === \"RUB\")\n    return <Rub v={v} color={props.color} />;\n\n  if (t === \"USD\")\n    return <Usd v={v} color={props.color} />;\n\n  return <Eur v={v} color={props.color} />;\n};\n\nexport const Prc = (props: { v: number; color?: boolean }): JSX.Element => {\n  const cls = c('percent', [props.v > 0, \"positive\"], [props.v < 0, \"negative\"], [props.color === true, \"color\"]);\n  return <span className={cls}>{fNum(props.v * 100)}%</span>;\n};\n","import { DateTime } from 'luxon';\nimport React from \"react\";\nimport uPlot from \"uplot\";\nimport \"uplot/dist/uPlot.min.css\";\nimport { Currency } from '../api/common';\nimport { fNum } from './spans';\n\ntype ValType = Currency | \"PERCENT\";\ninterface SeriaOpts {\n  label: string;\n  data: number[];\n}\n\ninterface Props {\n  timestamps: number[];\n\n  valType: ValType;\n\n  s1: SeriaOpts;\n  s2?: SeriaOpts;\n  s3?: SeriaOpts;\n  s4?: SeriaOpts;\n}\n\nfunction formatYear (d: Date): string {\n  return d.getFullYear().toString();\n}\n\nfunction formatMonth (d: Date): string {\n  return [\"Янв\", \"Фев\", \"Мар\", \"Апр\", \"Май\", \"Июнь\", \"Июль\", \"Авг\", \"Сен\", \"Окт\", \"Ноя\", \"Дек\"][d.getMonth()];\n}\n\nfunction formatDate (d: Date): string {\n  const date = d.getDate();\n  return date < 10 ? `0${date}` : date.toString();\n}\n\nfunction formatHour (d: Date): string {\n  const h = d.getHours();\n  return h < 10 ? `0${h}` : h.toString();\n}\n\ninterface DateFormatSpec {\n  timeGap: number;\n  regularFormat: (date: Date) => string;\n  yearGapFormat?: (date: Date) => string;\n  monthGapFormat?: (date: Date) => string;\n  dayGapFormat?: (date: Date) => string;\n}\n\nconst dateFormatSpecs: DateFormatSpec[] = [\n  {\n    timeGap: 365 * 24 * 60 * 60,\n    regularFormat: formatYear,\n  },\n  {\n    timeGap: 28 * 24 * 60 * 60,\n    regularFormat: formatMonth,\n    yearGapFormat: (d): string => `${formatMonth(d)}\\n${formatYear(d)}`\n  },\n  {\n    timeGap: 24 * 60 * 60,\n    regularFormat: formatDate,\n    yearGapFormat: (d): string => `${formatDate(d)}\\n${formatYear(d)}, ${formatMonth(d)}`,\n    monthGapFormat: (d): string => `${formatDate(d)}\\n${formatMonth(d)}`,\n  },\n  {\n    timeGap: 60 * 60,\n    regularFormat: formatHour,\n    dayGapFormat: (d): string => `${formatHour(d)}\\n${formatDate(d)} ${formatMonth(d)}`,\n    yearGapFormat: (d): string => `${formatHour(d)}\\n${formatDate(d)} ${formatMonth(d)} ${formatYear(d)}`\n  },\n  {\n    timeGap: 60,\n    regularFormat: (d): string => DateTime.fromJSDate(d).toFormat(\"HH:mm\"),\n    dayGapFormat: (d): string => `${DateTime.fromJSDate(d).toFormat(\"HH:mm\")}\\n${formatDate(d)} ${formatMonth(d)} ${formatYear(d)}`,\n  },\n  {\n    timeGap: 1,\n    regularFormat: (d): string => DateTime.fromJSDate(d).toFormat(\"HH:mm:ss\"),\n    dayGapFormat: (d): string => `${DateTime.fromJSDate(d).toFormat(\"HH:mm:ss\")}\\n${formatDate(d)} ${formatMonth(d)} ${formatYear(d)}`,\n  },\n  {\n    timeGap: 0,\n    regularFormat: (d): string => DateTime.fromJSDate(d).toFormat(\"HH:mm:ss.SSS\"),\n    dayGapFormat: (d): string => `${DateTime.fromJSDate(d).toFormat(\"HH:mm:ss.SSS\")}\\n${formatDate(d)} ${formatMonth(d)} ${formatYear(d)}`,\n  }\n];\n\nfunction formatDateVals (self: unknown, splits: number[]): string[] {\n  const gap = Math.ceil((splits[1] - splits[0]) * 1000) / 1000;\n  const s = dateFormatSpecs.find(function (e) { return gap >= e.timeGap; });\n\n  if (s === undefined) throw Error(\"Too small gap\");\n\n  // these track boundaries when a full label is needed again\n  let prevY: number | null = null;\n  let prevM: number | null = null;\n  let prevDate: number | null = null;\n\n  return splits.map((ts) => {\n    const d = new Date(ts * 1000);\n\n    const y = d.getFullYear();\n    const m = d.getMonth();\n    const date = d.getDate();\n\n    const diffY = y !== prevY;\n    const diffM = m !== prevM;\n    const diffDate = date !== prevDate;\n\n    prevY = y;\n    prevM = m;\n    prevDate = date;\n\n    if (diffY && s.yearGapFormat !== undefined) return s.yearGapFormat(d);\n    if (diffM && s.monthGapFormat !== undefined) return s.monthGapFormat(d);\n    if (diffDate && s.dayGapFormat !== undefined) return s.dayGapFormat(d);\n    return s.regularFormat(d);\n  });\n}\n\nfunction roundDigits (val: number, digits: number): number {\n  return Math.round(val * 10 * digits) / (10 * digits);\n}\n\nfunction formatValShort (val: number, type: ValType): string {\n  if (type === \"PERCENT\") {\n    return val.toFixed(0) + \"%\";\n  }\n\n  const curSign = { RUB: \"\\u20BD\", USD: \"$\", EUR: \"\\u20AC\" }[type];\n\n  if (val > 1000000) {\n    return `${curSign}${(val / 1000000).toFixed(0)}м`;\n  }\n\n  if (val > 1000) {\n    return `${curSign}${(val / 1000).toFixed(0)}т`;\n  }\n\n  if (val > 100) {\n    return `${curSign}${roundDigits(val / 1000, 1)}т`;\n  }\n\n  return `${curSign}${(val).toFixed(0)}`;\n}\n\nfunction formatValLong (val: number, type: ValType): string {\n  if (type === \"PERCENT\") {\n    return val.toFixed(2) + \"%\";\n  }\n\n  const curSign = { RUB: \"\\u20BD\", USD: \"$\", EUR: \"\\u20AC\" }[type];\n\n  return `${curSign} ${fNum(val)}`;\n}\n\nexport class Graph extends React.Component<Props> {\n  // private id: number;\n  private uplot: uPlot | null = null\n  private el: HTMLDivElement | null = null\n  private interval: number | null = null\n\n  private resizeListener = (): void => {\n    if (this.el === null || this.uplot === null) return;\n\n    this.uplot.setSize({ width: this.el.clientWidth, height: 300 });\n  };\n\n  componentDidMount (): void {\n    if (this.el === null) throw Error(\"No element?\");\n\n    window.addEventListener(\"resize\", this.resizeListener);\n\n    this.setupUPlot();\n\n    this.interval = window.setInterval(() => this.uplot?.syncRect(), 500);\n  }\n\n  setupUPlot (): void {\n    if (this.el === null) {\n      return;\n    }\n\n    if (this.uplot !== null) {\n      this.uplot.destroy();\n      this.uplot = null;\n    }\n\n    const { s1, s2, s3, s4 } = this.props;\n\n    const data = [\n      this.props.timestamps, s1.data\n    ];\n    const seriesOpts = {\n      width: 2,\n      value: (_: uPlot, v: number): string => formatValLong(v, this.props.valType)\n    };\n\n    const series: uPlot.Series[] = [\n      {\n        label: \"Дата\",\n        value: (_, timestamp): string => {\n          const d = new Date(timestamp * 1000);\n          return `${formatDate(d)} ${formatMonth(d)} ${formatYear(d)}`;\n        }\n      },\n      { ...seriesOpts, label: s1.label, stroke: \"#003f5c\", fill: \"#003f5c30\", }\n    ];\n\n    if (s2 !== undefined) {\n      data.push(s2.data);\n      series.push({ ...seriesOpts, label: s2.label, stroke: \"#7a5195\", fill: \"#7a519530\" });\n    }\n\n    if (s3 !== undefined) {\n      data.push(s3.data);\n      series.push({ ...seriesOpts, label: s3.label, stroke: \"#ef5675\", fill: \"#ef567530\", });\n    }\n\n    if (s4 !== undefined) {\n      data.push(s4.data);\n      series.push({ label: s4.label, stroke: \"#ffa600\", fill: \"#ffa60030\", });\n    }\n\n    const opts: uPlot.Options = {\n      width: this.el.clientWidth,\n      height: 300,\n      series,\n      fmtDate: () => (): string => '',\n      axes: [\n        {\n          values: formatDateVals\n        },\n        {\n          values: (_, splits): string[] => splits.map(s => formatValShort(s, this.props.valType))\n        }\n      ]\n    };\n\n    this.uplot = new uPlot(opts, data, this.el);\n  }\n\n  componentDidUpdate (): void {\n    this.setupUPlot();\n  }\n\n  componentWillUnmount (): void {\n    window.removeEventListener(\"resize\", this.resizeListener);\n\n    if (this.interval !== null)\n      window.clearInterval(this.interval);\n  }\n\n  render (): JSX.Element {\n    return (\n      <div ref={(el): void => { this.el = el; }} />\n    );\n  }\n}\n","import { faAngleDown, faAngleUp } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { DateTime } from 'luxon';\nimport React from \"react\";\nimport { Currency, Operation } from '../api/common';\nimport { Instrument, InstrumentsMap } from '../api/instruments';\nimport { InstrumentState } from '../stats/instrumentState';\nimport { DayStats as DayState } from '../stats/stats';\nimport { CurrenciesCalc, toCur, toRub } from '../tools/currencies';\nimport { sortInstruments } from '../tools/instruments';\nimport { c } from '../tools/react';\nimport { CurrenciesSwitch } from '../widgets/currenciesSwitch';\nimport { DaysSwitch } from '../widgets/daysSwitch';\nimport { Graph } from '../widgets/graph';\nimport { Cur, Prc, Rub } from '../widgets/spans';\nimport './history.scss';\n\ninterface Props {\n  instruments: InstrumentsMap;\n  states: DayState[];\n}\n\ninterface State {\n  drawAllTime: boolean;\n  drawDay1: boolean;\n  drawDay7: boolean;\n  drawDay30: boolean;\n\n  currency: Currency;\n  expandedDays: ReadonlySet<string>;\n}\n\nfunction calcTotalRub (dayState: DayState): number {\n  let total = dayState.rub;\n  total += dayState.usd * dayState.usdPrice;\n  total += dayState.eur * dayState.eurPrice;\n\n  for (const i of Object.values(dayState.portfolio)) {\n    total += toRub(i.currency, i.amount * i.price, dayState.usdPrice, dayState.eurPrice);\n  }\n\n  return total;\n}\n\nfunction calcTotalOwnRub (dayState: DayState): number {\n  return dayState.ownRub + dayState.ownUsd * dayState.usdPrice + dayState.ownEur * dayState.eurPrice;\n}\n\ninterface DayStat {\n  date: number;\n\n  totalCur: number;\n  totalOwnCur: number;\n\n  added1: number;\n  added7: number;\n  added30: number;\n\n  performance: number;\n  performance1: number;\n  performance7: number;\n  performance30: number;\n}\n\nexport class HistoryBlock extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      drawAllTime: true,\n      drawDay1: false,\n      drawDay7: false,\n      drawDay30: true,\n\n      currency: \"RUB\",\n      expandedDays: new Set()\n    };\n  }\n\n  render (): JSX.Element {\n    const dayStates = this.props.states;\n\n    const dayStats: DayStat[] = dayStates.map((dayState, i) => {\n      const dayState1 = dayStates[Math.max(0, i - 1)];\n      const dayState7 = dayStates[Math.max(0, i - 7)];\n      const dayState30 = dayStates[Math.max(0, i - 30)];\n\n      const totalCur = toCur(this.state.currency, \"RUB\", calcTotalRub(dayState), dayState.usdPrice, dayState.eurPrice);\n      const totalOwnCur = toCur(\n        this.state.currency, \"RUB\", calcTotalOwnRub(dayState), dayState.usdPrice, dayState.eurPrice\n      );\n\n      const totalCur1 = toCur(\n        this.state.currency, \"RUB\", calcTotalRub(dayState1), dayState.usdPrice, dayState.eurPrice);\n      const totalCur7 = toCur(\n        this.state.currency, \"RUB\", calcTotalRub(dayState7), dayState.usdPrice, dayState.eurPrice);\n      const totalCur30 = toCur(\n        this.state.currency, \"RUB\", calcTotalRub(dayState30), dayState.usdPrice, dayState.eurPrice);\n\n      const totalOwnCur1 = toCur(\n        this.state.currency, \"RUB\", calcTotalOwnRub(dayState1), dayState.usdPrice, dayState.eurPrice\n      );\n      const totalOwnCur7 = toCur(\n        this.state.currency, \"RUB\", calcTotalOwnRub(dayState7), dayState.usdPrice, dayState.eurPrice\n      );\n      const totalOwnCur30 = toCur(\n        this.state.currency, \"RUB\", calcTotalOwnRub(dayState30), dayState.usdPrice, dayState.eurPrice\n      );\n\n      const added1 = totalOwnCur - totalOwnCur1;\n      const added7 = totalOwnCur - totalOwnCur7;\n      const added30 = totalOwnCur - totalOwnCur30;\n\n      const performance = (totalCur - totalOwnCur) / totalCur;\n      const performance1 = (totalCur - totalCur1 - added1) / totalCur;\n      const performance7 = (totalCur - totalCur7 - added7) / totalCur;\n      const performance30 = (totalCur - totalCur30 - added30) / totalCur;\n\n      return {\n        date: dayState.date.getTime(),\n\n        usdPrice: dayState.usdPrice,\n        eurPrice: dayState.eurPrice,\n\n        totalCur,\n        totalOwnCur,\n\n        added1,\n        added7,\n        added30,\n\n        performance,\n        performance1,\n        performance7,\n        performance30\n      };\n    });\n\n    const reverseDayStates = [...dayStates].reverse().slice(0, 100);\n    const reverseDayStats = [...dayStats].reverse().slice(0, 100);\n\n    const perfLabel = this.state.drawDay1 ? \"За день\" : (this.state.drawDay7 ? \"За 7 дней\" : \"За 30 дней\");\n    const perfData = dayStats.map(\n      s => (this.state.drawDay1 ?\n        s.performance1 * 100 :\n        (this.state.drawDay7 ? (s.performance7 * 100) : (s.performance30 * 100)))\n    );\n\n    const { currency } = this.state;\n\n    return (\n      <div className='bHistory'>\n        <CurrenciesSwitch currency={currency} onCurSwitch={(currency): void => this.setState({ currency })} />\n        <h1>Стоимость портфеля и вложения</h1>\n        <Graph\n          timestamps={dayStats.map(s => s.date / 1000)}\n          valType={currency}\n          s1={{ label: \"Стоимость портфеля\", data: dayStats.map(s => s.totalCur) }}\n          s2={{ label: \"Инвестированно (выведено)\", data: dayStats.map(s => s.totalOwnCur) }}\n        />\n        <h1>Доходы и потери</h1>\n        <DaysSwitch\n          drawAllTime={this.state.drawAllTime}\n          drawDay1={this.state.drawDay1}\n          drawDay7={this.state.drawDay7}\n          drawDay30={this.state.drawDay30}\n\n          setFlags={(a, d1, d7, d30): void =>\n            this.setState({ drawAllTime: a, drawDay1: d1, drawDay7: d7, drawDay30: d30 })}\n        />\n        {\n          this.state.drawAllTime ?\n            <Graph\n              timestamps={dayStats.map(s => s.date / 1000)}\n              valType='PERCENT'\n              s1={{ label: perfLabel, data: perfData }}\n              s2={{ label: \"За все время\", data: dayStats.map(s => s.performance * 100) }}\n            /> :\n            <Graph\n              timestamps={dayStats.map(s => s.date / 1000)}\n              valType='PERCENT'\n              s1={{ label: perfLabel, data: perfData }}\n            />\n        }\n        <div>\n          {reverseDayStates.map((s, i) => this.renderDayStats(s, reverseDayStats[i]))}\n        </div>\n      </div>\n    );\n  }\n\n  renderDayStats (dayState: DayState, dayStat: DayStat): JSX.Element {\n    const expanded = this.state.expandedDays.has(dayState.date.toISOString());\n\n    const portfolio = sortInstruments(dayState.portfolio, this.props.instruments, dayState.usdPrice, dayState.eurPrice);\n\n    const available = new CurrenciesCalc(dayState.usdPrice, dayState.eurPrice)\n      .addRub(dayState.rub).addUsd(dayState.usd).addEur(dayState.eur).cur(this.state.currency);\n\n    const own = new CurrenciesCalc(dayState.usdPrice, dayState.eurPrice)\n      .addRub(dayState.ownRub).addUsd(dayState.ownUsd).addEur(dayState.ownEur).cur(this.state.currency);\n\n    return (\n      <div key={`day-${dayState.date.toISOString()}`} className='dayStats'>\n        <div className='title'>\n          <span className='date'>{DateTime.fromJSDate(dayState.date).toISODate()}</span>{' '}\n          USD: <Rub v={dayState.usdPrice} />{' '}\n          EUR: <Rub v={dayState.eurPrice} />\n        </div>\n        <div className='avail'>\n          Доступно: <Cur t={this.state.currency} v={available} />\n        </div>\n        <div className='own'>\n          Инвестировано (выведено): <Cur t={this.state.currency} v={own} />\n        </div>\n        <div className='portfolio'>\n          {portfolio\n            .filter(i => i.amount !== 0)\n            .map(i => this.renderInstrument(i, this.state.currency, dayState.usdPrice, dayState.eurPrice))}\n        </div>\n        <div className='total'>\n          Итого: <Cur t={this.state.currency} v={dayStat.totalCur} />\n          {' '}За все время: <Prc v={dayStat.performance} color />\n          {' '}За день: <Prc v={dayStat.performance1} color />\n          {' '}За 7 дней: <Prc v={dayStat.performance7} color />\n          {' '}За 30 дней: <Prc v={dayStat.performance30} color />\n        </div>\n        <div\n          className={c('ops-expander', [expanded, \"expanded\"])}\n          onClick={(): void => this.flipExpandedDay(dayState.date)}\n        >\n          {dayState.ops.length} операций\n          {dayState.ops.length > 0 ?\n            <button onClick={(): void => this.flipExpandedDay(dayState.date)}>\n              {expanded ?\n                <span><FontAwesomeIcon icon={faAngleUp} /> скрыть</span> :\n                <span><FontAwesomeIcon icon={faAngleDown} /> показать</span>}\n            </button> :\n            undefined}\n        </div>\n        {\n          expanded ?\n            <div className='ops'>\n              {dayState.ops.map((op, i) => this.renderOp(op, i.toString()))}\n            </div> :\n            undefined\n        }\n      </div>\n    );\n  }\n\n  renderInstrument (instrument: InstrumentState, cur: Currency, usdPrice: number, eurPrice: number): JSX.Element {\n    const info = this.props.instruments[instrument.figi];\n    if (info === undefined) throw Error(\"Instrument not found\");\n\n    return (\n      <span key={`i-${instrument.figi}`}>\n        {info.ticker}({instrument.amount}):{' '}\n        <Cur t={cur} v={toCur(cur, instrument.currency, instrument.price * instrument.amount, usdPrice, eurPrice)} />\n      </span>\n    );\n  }\n\n  renderOp (op: Operation, key: string): JSX.Element {\n    const opJson: Operation & { instrument?: Instrument } = { ...op };\n\n    if (opJson.figi !== undefined) {\n      opJson.instrument = this.props.instruments[opJson.figi];\n    }\n\n    return (\n      <pre key={key}>{JSON.stringify(opJson, undefined, 2)}</pre>\n    );\n  }\n\n  flipExpandedDay (date: Date): void {\n    const ed = new Set(this.state.expandedDays);\n    if (ed.has(date.toISOString())) {\n      ed.delete(date.toISOString());\n    } else {\n      ed.add(date.toISOString());\n    }\n    this.setState({ expandedDays: ed });\n  }\n}\n","import React from \"react\";\nimport { setApiToken } from '../api/token';\nimport \"./loginForm.scss\";\n\ninterface Props {\n  onLoggedIn: () => void;\n}\n\ninterface State {\n  token: string;\n}\n\nexport class LoginForm extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      token: \"\"\n    };\n  }\n\n  render (): JSX.Element {\n    return (\n      <div className='bLoginForm'>\n        <form>\n          <input\n            type='text'\n            value={this.state.token}\n            onChange={(ev): void => this.setState({ token: ev.target.value })}\n            placeholder='API Token'\n            autoFocus\n          />\n          <button type='button' onClick={(): void => this.onLoginClick()}>Login</button>\n        </form>\n      </div>\n    );\n  }\n\n  onLoginClick (): void {\n    if (this.state.token === \"\") return;\n\n    setApiToken(this.state.token);\n\n    this.props.onLoggedIn();\n  }\n}","import { DateTime, Duration } from 'luxon';\nimport { Range } from 'rc-slider';\nimport React from \"react\";\nimport DatePicker from 'react-datepicker';\nimport 'react-datepicker/dist/react-datepicker.min.css';\nimport uPlot from 'uplot';\nimport \"uplot/dist/uPlot.min.css\";\nimport { DayStats } from '../stats/stats';\nimport { CurrenciesCalc } from '../tools/currencies';\nimport \"./dateRangeSelector.scss\";\n\ninterface Props {\n  min: DateTime;\n  max: DateTime;\n\n  start: DateTime;\n  end: DateTime;\n\n  timeline: DayStats[];\n\n  onChange: (start: DateTime, end: DateTime) => void;\n}\n\nexport class DateRangeSelector extends React.Component<Props> {\n  uPlot: uPlot | null = null\n  chartDiv: HTMLDivElement | null = null\n\n  componentDidMount (): void {\n    if (this.chartDiv === null) return;\n\n    const opts: uPlot.Options = {\n      width: this.chartDiv.clientWidth,\n      height: this.chartDiv.clientHeight,\n      class: \"spark\",\n      cursor: {\n        show: false\n      },\n      // select: {\n      //   show: false,\n      // },\n      legend: {\n        show: false,\n      },\n      scales: {\n        x: {\n          time: false,\n        },\n      },\n      axes: [\n        {\n          show: false,\n        },\n        {\n          show: false,\n        }\n      ],\n      series: [\n        {},\n        {\n          stroke: \"#aaaaaa\",\n          fill: \"#aaaaaa\",\n        },\n      ],\n      fmtDate: () => (): string => \"\"\n    };\n    this.uPlot = new uPlot(opts, this.data(), this.chartDiv);\n  }\n\n  componentWillUnmount (): void {\n    this.uPlot?.destroy();\n    this.uPlot = null;\n  }\n\n  componentDidUpdate (): void {\n    this.uPlot?.setData(this.data());\n  }\n\n  render (): JSX.Element {\n    const max = this.props.max.diff(this.props.min).as(\"days\");\n    const startPos = this.props.start.diff(this.props.min).as(\"days\");\n    const endPos = this.props.end.diff(this.props.min).as(\"days\");\n\n    return (\n      <div className='cDateRangeSelector'>\n        <div className='dates'>\n          <div className='from'>\n            С\n            <DatePicker\n              dateFormat='yyyy-MM-dd'\n              selected={this.props.start.toJSDate()}\n              onChange={\n                (date): void =>\n                  this.props.onChange(date !== null ? DateTime.fromJSDate(date) : this.props.min, this.props.end)\n              }\n            />\n          </div>\n          <div className='until'>\n            по\n            <DatePicker\n              dateFormat='yyyy-MM-dd'\n              selected={this.props.end.toJSDate()}\n              onChange={\n                (date): void =>\n                  this.props.onChange(this.props.start, date !== null ? DateTime.fromJSDate(date) : this.props.max)\n              }\n            />\n          </div>\n        </div>\n\n        <div className='range-chart'>\n          <div className='chart' ref={(el): void => { this.chartDiv = el; }} />\n\n          <Range\n            min={0}\n            max={max}\n            value={[startPos, endPos]}\n            onChange={([start, end]): void =>\n              this.props.onChange(this.posToDate(start), this.posToDate(end))}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  posToDate (position: number): DateTime {\n    return this.props.min.plus(Duration.fromObject({ days: position }));\n  }\n\n  data (): number[][] {\n    const date: number[] = [];\n    const total: number[] = [];\n\n    for (const d of this.props.timeline) {\n      date.push(d.date.getTime());\n      const t = new CurrenciesCalc(d.usdPrice, d.eurPrice);\n      t.add(\"RUB\", d.rub).add(\"USD\", d.usd).add(\"EUR\", d.eur);\n      for (const i of Object.values(d.portfolio)) {\n        t.add(i.currency, i.price * i.amount);\n      }\n      total.push(t.usd());\n    }\n\n    return [date, total];\n  }\n}","import { Operation } from \"../api/common\";\n\nexport function opQuantity (op: Operation): number | undefined {\n  if (op.trades !== undefined) {\n    return op.trades.map(t => t.quantity).reduce((p, c) => p + c, 0);\n  }\n\n  return op.quantity;\n}","import { faAngleRight, faChevronDown, faChevronUp, faCoins, faWallet } from \"@fortawesome/free-solid-svg-icons\";\nimport { FontAwesomeIcon } from \"@fortawesome/react-fontawesome\";\nimport { DateTime } from \"luxon\";\nimport React from \"react\";\nimport { Currency, Operation } from \"../api/common\";\nimport { InstrumentsMap } from '../api/instruments';\nimport { InstrumentState } from '../stats/instrumentState';\nimport { DayStats } from '../stats/stats';\nimport { toEur, toRub, toUsd } from '../tools/currencies';\nimport { plural } from \"../tools/lang\";\nimport { opQuantity } from \"../tools/operations\";\nimport { Cur, Eur, Rub, Usd } from \"./spans\";\n\ninterface Props {\n  instruments: InstrumentsMap;\n  i: InstrumentState;\n\n  initDay: DayStats | undefined;\n  curDay: DayStats;\n}\n\ninterface State {\n  expanded: boolean;\n}\n\nexport class Instrument extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      expanded: false\n    };\n  }\n\n  render (): JSX.Element[] {\n    const { instruments, i, initDay, curDay } = this.props;\n\n    const instrumentInfo = instruments[i.figi];\n    if (instrumentInfo === undefined) throw Error(\"Unknown instrument\");\n\n    const initialInstrumentState = initDay?.portfolio?.[i.figi];\n    const initialInstrumentCost = (initialInstrumentState?.amount ?? 0) * (initialInstrumentState?.price ?? 0);\n\n    let effect = i.amount * i.price - initialInstrumentCost;\n\n    const startDt = initDay === undefined ? DateTime.fromMillis(0) : DateTime.fromJSDate(initDay.date).plus({ days: 1 });\n\n    for (const op of i.ops) {\n      if (DateTime.fromISO(op.date) <= startDt) continue;\n\n      if (op.operationType.startsWith(\"Buy\")) {\n        const q = opQuantity(op);\n        if (q === undefined) throw Error(\"undefined quantity\");\n        effect -= op.price * q;\n      } else if (op.operationType === \"Sell\") {\n        const q = opQuantity(op);\n        if (q === undefined) throw Error(\"undefined quantity\");\n        effect += op.price * q;\n      } else if (op.operationType === \"Dividend\") {\n        effect += op.payment;\n      }\n    }\n\n    const op1 = i.ops[i.ops.length - 1];\n\n    const result = [\n      <tr key={i.figi} className='inst-main-line'>\n        <td className='name'>\n          {instrumentInfo.name}\n        </td>\n        <td>{i.amount} {'\\xD7'} <Cur t={i.currency} v={i.price} /> = <Cur t={i.currency} v={i.amount * i.price} /></td>\n        {this.renderAllCurrenciesColumns(i.currency, i.price * i.amount, curDay.usdPrice, curDay.eurPrice)}\n      </tr>,\n      <tr key={i.figi + \"-sl\"} className='inst-ticker-line'>\n        <td className='ticker'>\n          {instrumentInfo.ticker}\n        </td>\n        <td><Cur t={i.currency} v={effect} color /></td>\n        {this.renderAllCurrenciesColumns(i.currency, effect, curDay.usdPrice, curDay.eurPrice, true)}\n      </tr>\n    ];\n\n    if (this.state.expanded) {\n      result.push(\n        <tr key={`expand-${i.figi}`}>\n          <td colSpan={2}>\n            {i.ops.length} операций{' '}\n            <button onClick={(): void => this.setState({ expanded: false })}>\n              <FontAwesomeIcon icon={faChevronUp} /> Скрыть\n            </button>\n          </td>\n          {this.renderEmptyAllCurrenciesColumns()}\n        </tr>\n      );\n\n      const ops = [...i.ops].reverse();\n\n      for (const op of ops) {\n        if (DateTime.fromISO(op.date) <= startDt) continue;\n        result.push(this.renderOperation(i, op, curDay.usdPrice, curDay.eurPrice));\n      }\n\n      if (initDay !== undefined && initialInstrumentState !== undefined) {\n        const is = initialInstrumentState;\n        result.push(\n          <tr key='initial' className='op-line'>\n            <td>{DateTime.fromJSDate(initDay.date).toISODate()} в портфеле</td>\n            <td>\n              {is.amount} {'\\xD7 '}\n              <Cur t={is.currency} v={is.price} />{' '}\n              = <Cur t={is.currency} v={is.amount * is.price} />\n            </td>\n            {this.renderAllCurrenciesColumns(is.currency, is.amount * is.price, initDay.usdPrice, initDay.eurPrice)}\n          </tr>\n        );\n      }\n    } else if (i.ops.length === 1) {\n      result.push(\n        <tr key={`expand-${i.figi}`}>\n          <td colSpan={2}>1 операция</td>\n          {this.renderEmptyAllCurrenciesColumns()}\n        </tr>\n      );\n      result.push(\n        this.renderOperation(i, op1, curDay.usdPrice, curDay.eurPrice)\n      );\n    } else {\n      result.push(\n        <tr key={`expand-${i.figi}`}>\n          <td colSpan={2}>\n            {i.ops.length} {plural(i.ops.length, \"операция\", \"операции\", \"операций\")}{' '}\n            <button onClick={(): void => this.setState({ expanded: true })}>\n              <FontAwesomeIcon icon={faChevronDown} /> Показать все\n            </button>\n          </td>\n          {this.renderEmptyAllCurrenciesColumns()}\n        </tr>\n      );\n      result.push(\n        this.renderOperation(i, op1, curDay.usdPrice, curDay.eurPrice)\n      );\n      result.push(\n        <tr key={`op-more-${i.figi}`}>\n          <td colSpan={2}>...</td>\n          <td colSpan={3} className='all-cur' />\n        </tr>\n      );\n    }\n\n    return result;\n  }\n\n  renderAllCurrenciesColumns (\n    cur: Currency, amount: number, usdPrice: number, eurPrice: number, color?: boolean\n  ): JSX.Element[] {\n    return [\n      <td key='total-rub' className='all-cur'><Rub v={toRub(cur, amount, usdPrice, eurPrice)} color={color} /></td>,\n      <td key='total-usd' className='all-cur'><Usd v={toUsd(cur, amount, usdPrice, eurPrice)} color={color} /></td>,\n      <td key='total-eur' className='all-cur'><Eur v={toEur(cur, amount, usdPrice, eurPrice)} color={color} /></td>\n    ];\n  }\n\n  renderEmptyAllCurrenciesColumns (): JSX.Element[] {\n    return [\n      <td key='total-rub' className='all-cur' />,\n      <td key='total-usd' className='all-cur' />,\n      <td key='total-eur' className='all-cur' />\n    ];\n  }\n\n  renderOperation (i: InstrumentState, op: Operation, usdPrice: number, eurPrice: number): JSX.Element {\n    if (op.operationType === \"Buy\" || op.operationType === \"BuyCard\" || op.operationType === \"Sell\") {\n      const opName = {\n        \"Buy\": <span><FontAwesomeIcon icon={faAngleRight} /> <FontAwesomeIcon icon={faWallet} /></span>,\n        \"BuyCard\": <span><FontAwesomeIcon icon={faAngleRight} /> <FontAwesomeIcon icon={faWallet} /></span>,\n        \"Sell\": <span><FontAwesomeIcon icon={faWallet} /> <FontAwesomeIcon icon={faAngleRight} /></span>\n      }[op.operationType as unknown as \"Buy\" | \"BuyCard\" | \"Sell\"];\n\n      const q = opQuantity(op);\n      if (q === undefined) throw Error(\"undefined quantity\");\n\n      return (\n        <tr key={`${i.figi}-op-${op.date}-${op.id}`} className='op-line'>\n          <td>{DateTime.fromISO(op.date).toISODate()} {opName}</td>\n          <td>\n            {q} {'\\xD7'} <Cur t={op.currency} v={op.price} />{' '}\n            = <Cur t={op.currency} v={q * op.price} />\n          </td>\n          {this.renderAllCurrenciesColumns(op.currency, q * op.price, usdPrice, eurPrice)}\n        </tr>\n      );\n    }\n\n    if (op.operationType === \"Dividend\") {\n      return (\n        <tr key={`${i.figi}-op-${op.date}-${op.id}`} className='op-line'>\n          <td>{DateTime.fromISO(op.date).toISODate()} <FontAwesomeIcon icon={faCoins} /></td>\n          <td><Cur t={op.currency} v={op.payment} /></td>\n          {this.renderAllCurrenciesColumns(op.currency, op.payment, usdPrice, eurPrice)}\n        </tr>\n      );\n    }\n\n    throw Error(\"Unexpected operationType\");\n  }\n}","export function plural (n: number, form0: string, form1: string, form2: string): string {\n  if (n % 10 === 1 && n % 100 !== 11) {\n    return form0;\n  }\n\n  if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20)) {\n    return form1;\n  }\n\n  return form2;\n}","import { DateTime, Duration } from \"luxon\";\nimport React from \"react\";\nimport { Currency } from '../api/common';\nimport { InstrumentsMap } from '../api/instruments';\nimport { DayStats } from '../stats/stats';\nimport { CurrenciesCalc, toEur, toRub, toUsd } from '../tools/currencies';\nimport { sortInstruments } from \"../tools/instruments\";\nimport { DateRangeSelector } from \"../widgets/dateRangeSelector\";\nimport { Instrument } from \"../widgets/instrument\";\nimport { Cur, Eur, Prc, Rub, Usd } from \"../widgets/spans\";\nimport './portfolio.scss';\n\ninterface Props {\n  instruments: InstrumentsMap;\n  timeline: DayStats[];\n}\n\ninterface State {\n  startPosition: number;\n  endPosition: number;\n  expandedInstruments: ReadonlySet<string>;\n}\n\nexport class PortfolioBlock extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      startPosition: 0,\n      endPosition: props.timeline.length - 1,\n      expandedInstruments: new Set()\n    };\n  }\n\n  render (): JSX.Element {\n    const { timeline, instruments } = this.props;\n    const initial = timeline[this.state.startPosition - 1] as DayStats | undefined;\n    const current = timeline[this.state.endPosition];\n\n    const initialTotal = new CurrenciesCalc(initial?.usdPrice ?? 1, initial?.eurPrice ?? 1);\n    initialTotal.addRub(initial?.rub ?? 0).addUsd(initial?.usd ?? 0).addEur(initial?.eur ?? 0);\n    for (const i of Object.values(initial?.portfolio ?? {})) {\n      initialTotal.add(i.currency, i.amount * i.price);\n    }\n\n    const currentTotal = new CurrenciesCalc(current.usdPrice, current.eurPrice);\n    currentTotal.addRub(current.rub).addUsd(current.usd).addEur(current.eur);\n    for (const i of Object.values(current.portfolio)) {\n      currentTotal.add(i.currency, i.amount * i.price);\n    }\n\n    const initialOwn = new CurrenciesCalc(initial?.usdPrice ?? 1, initial?.eurPrice ?? 1)\n      .addRub(initial?.ownRub ?? 0).addUsd(initial?.ownUsd ?? 0).addEur(initial?.ownEur ?? 0);\n\n    const currentOwn = new CurrenciesCalc(current.usdPrice, current.eurPrice)\n      .addRub(current.ownRub).addUsd(current.ownUsd).addEur(current.ownEur);\n\n    const addedUsd = currentOwn.usd() - initialOwn.usd();\n\n    const minDate = DateTime.fromJSDate(timeline[0].date);\n    const maxDate = DateTime.fromJSDate(timeline[timeline.length - 1].date);\n    const startDate = minDate.plus(Duration.fromObject({ days: this.state.startPosition }));\n    const endDate = minDate.plus(Duration.fromObject({ days: this.state.endPosition }));\n\n    return (\n      <div className='bPortfolio'>\n        <DateRangeSelector\n          min={minDate}\n          max={maxDate}\n          start={startDate}\n          end={endDate}\n          timeline={timeline}\n          onChange={(start, end): void => {\n            this.setState({\n              startPosition: this.dateToPos(start) ?? 0,\n              endPosition: this.dateToPos(end) ?? (timeline.length - 1)\n            });\n          }}\n        />\n        <h1>Полная стоимость портфеля</h1>\n        <div className='bPortfolio-full-cost'>\n          <Rub v={currentTotal.rub()} />\n          <Usd v={currentTotal.usd()} />\n          <Eur v={currentTotal.eur()} />\n          <Prc v={(currentTotal.usd() - initialTotal.usd() - addedUsd) / currentTotal.usd()} color />\n        </div>\n        <table>\n          <tbody>\n            {this.renderOwnMoney(current)}\n            {this.renderAvailable(current)}\n            <tr>\n              <th colSpan={2} className='th-first-line'>Инструменты</th>\n              {this.renderEmptyAllCurrenciesColumns()}\n            </tr>\n            {sortInstruments(current.portfolio, instruments, current.usdPrice, current.eurPrice)\n              .map(i => <Instrument key={i.figi} instruments={instruments} i={i} initDay={initial} curDay={current} />)}\n          </tbody>\n        </table>\n      </div>\n    );\n  }\n\n  renderAvailable (portfolio: DayStats): JSX.Element[] {\n    const availLine = (c: Currency): JSX.Element => {\n      let v = portfolio.rub;\n      if (c === \"USD\") v = portfolio.usd;\n      if (c === \"EUR\") v = portfolio.eur;\n      return (\n        <tr key={`avail-${c}`}>\n          <td colSpan={2}>\n            <Cur t={c} v={v} />\n          </td>\n          {this.renderAllCurrenciesColumns(c, v, portfolio.usdPrice, portfolio.eurPrice)}\n        </tr>\n      );\n    };\n\n    const total = new CurrenciesCalc(portfolio.usdPrice, portfolio.eurPrice)\n      .addRub(portfolio.rub).addUsd(portfolio.usd).addEur(portfolio.eur);\n\n    return [\n      <tr key='available-th'>\n        <th colSpan={2} className='th-first-line'>Доступно</th>\n        {this.renderEmptyAllCurrenciesColumns()}\n      </tr>,\n      availLine(\"RUB\"),\n      availLine(\"USD\"),\n      availLine(\"EUR\"),\n      <tr key='available-total' className='total'>\n        <th colSpan={2}>\n          Всего\n        </th>\n        {this.renderAllCurrenciesColumns(\"RUB\", total.rub(), portfolio.usdPrice, portfolio.eurPrice)}\n      </tr>\n    ];\n  }\n\n  renderOwnMoney (portfolio: DayStats): JSX.Element[] {\n    const ownMoneyLine = (c: Currency): JSX.Element => {\n      const ownMoneyCase = { \"RUB\": \"ownRub\", \"USD\": \"ownUsd\", \"EUR\": \"ownEur\" }[c];\n      const v = (portfolio as unknown as { [_: string]: number })[ownMoneyCase];\n      return (\n        <tr key={`ownMoney-${c.toLowerCase()}`}>\n          <td colSpan={2}>\n            <Cur t={c} v={v} />\n          </td>\n          {this.renderAllCurrenciesColumns(c, v, portfolio.usdPrice, portfolio.eurPrice)}\n        </tr>\n      );\n    };\n\n    const totalOwn = new CurrenciesCalc(portfolio.usdPrice, portfolio.eurPrice)\n      .addRub(portfolio.ownRub).addUsd(portfolio.ownUsd).addEur(portfolio.ownEur);\n\n    return [\n      <tr key='ownMoney-th'>\n        <th colSpan={2} className='th-first-line'>Инвестированно (выведено)</th>\n        <th colSpan={3} className='all-cur'>В разных валютах</th>\n      </tr>,\n      ownMoneyLine(\"RUB\"),\n      ownMoneyLine(\"USD\"),\n      ownMoneyLine(\"EUR\"),\n      <tr key='ownMoney-total' className='total'>\n        <th colSpan={2}>\n          Всего\n        </th>\n        {this.renderAllCurrenciesColumns(\"RUB\", totalOwn.rub(), portfolio.usdPrice, portfolio.eurPrice)}\n      </tr>\n    ];\n  }\n\n  renderAllCurrenciesColumns (\n    cur: Currency, amount: number, usdPrice: number, eurPrice: number, color?: boolean\n  ): JSX.Element[] {\n    return [\n      <td key='total-rub' className='all-cur'><Rub v={toRub(cur, amount, usdPrice, eurPrice)} color={color} /></td>,\n      <td key='total-usd' className='all-cur'><Usd v={toUsd(cur, amount, usdPrice, eurPrice)} color={color} /></td>,\n      <td key='total-eur' className='all-cur'><Eur v={toEur(cur, amount, usdPrice, eurPrice)} color={color} /></td>\n    ];\n  }\n\n  renderEmptyAllCurrenciesColumns (): JSX.Element[] {\n    return [\n      <td key='total-rub' className='all-cur' />,\n      <td key='total-usd' className='all-cur' />,\n      <td key='total-eur' className='all-cur' />\n    ];\n  }\n\n  dateToPos (date: DateTime): number | undefined {\n    const days = date.diff(DateTime.fromJSDate(this.props.timeline[0].date)).as(\"days\");\n\n    if (days < 0 || days > this.props.timeline.length - 1) {\n      return undefined;\n    }\n\n    return days;\n  }\n}\n","import { faSpinner } from \"@fortawesome/free-solid-svg-icons\";\nimport { FontAwesomeIcon } from \"@fortawesome/react-fontawesome\";\nimport React from \"react\";\nimport { c } from \"../tools/react\";\nimport { Rub } from \"../widgets/spans\";\nimport \"./topPanel.scss\";\n\ninterface Props {\n  activeTab: \"PF\" | \"TL\";\n  onTabClick: (tab: \"PF\" | \"TL\") => void;\n  onReloadClick: () => void;\n  onLogoutClick: () => void;\n  loading: boolean;\n  usdPrice?: number;\n  eurPrice?: number;\n}\n\nexport class TopPanelBlock extends React.Component<Props> {\n  render (): JSX.Element {\n    const { activeTab, usdPrice, eurPrice, onTabClick } = this.props;\n\n    return (\n      <div className='bTopPanel'>\n        <div\n          className={c(\"tab\", [activeTab === \"PF\", \"active-tab\"])}\n          onClick={(): void => onTabClick(\"PF\")}\n        >Портфель\n        </div>\n        <div\n          className={c(\"tab\", [activeTab === \"TL\", \"active-tab\"])}\n          onClick={(): void => onTabClick(\"TL\")}\n        >История\n        </div>\n        <div className='spacer' />\n        <div>\n          USD: {usdPrice === undefined ? \"?\" : <Rub v={usdPrice} />}{' '}\n          EUR: {eurPrice === undefined ? \"?\" : <Rub v={eurPrice} />}\n        </div>\n        <div>\n          <button onClick={this.props.onLogoutClick}>Выйти</button>\n        </div>\n        <div>\n          {\n            this.props.loading ?\n              <FontAwesomeIcon icon={faSpinner} pulse /> :\n              <button onClick={this.props.onReloadClick}>Обновить</button>\n          }\n        </div>\n      </div>\n    );\n  }\n}","import { deepCopy } from 'deep-copy-ts';\nimport { Candle, findPrice, lastPrice } from '../api/candles';\nimport { Operation } from '../api/common';\nimport { Instrument, InstrumentsMap } from '../api/instruments';\nimport { opQuantity } from '../tools/operations';\nimport { InstrumentState } from './instrumentState';\n\nconst NoFigiOps = new Set([\"PayIn\", \"Tax\", \"TaxBack\", \"PayOut\", \"MarginCommission\"]);\nexport const EUR_FIGI = \"BBG0013HJJ31\";\nexport const USD_FIGI = \"BBG0013HGFT4\";\n\nexport interface DayStats {\n  date: Date;\n\n  // what in pocket on the date\n  rub: number;\n  usd: number;\n  eur: number;\n  portfolio: {\n    [figi: string]: InstrumentState;\n  };\n\n  // market cost\n  usdPrice: number;\n  eurPrice: number;\n\n  // in/out ops all time\n  ownRub: number;\n  ownUsd: number;\n  ownEur: number;\n\n  ops: Operation[];\n}\n\nfunction startDay (date: Date): Date {\n  const d = new Date(date);\n  d.setHours(0, 0, 0, 0);\n  return d;\n}\n\nfunction nextDay (date: Date): Date {\n  const d = new Date(date);\n  d.setHours(0, 0, 0, 0);\n  d.setDate(d.getDate() + 1);\n  return d;\n}\n\nexport class Stats {\n  private instrumentsMap: InstrumentsMap\n  private ops: Operation[]\n  private candles: { [figi: string]: Candle[] }\n\n  constructor(figiMap: InstrumentsMap, ops: Operation[], candles: { [figi: string]: Candle[] }) {\n    this.instrumentsMap = figiMap;\n    this.ops = ops;\n    this.candles = candles;\n  }\n\n  usdPrice (): number {\n    return lastPrice(this.candles[USD_FIGI]);\n  }\n\n  eurPrice (): number {\n    return lastPrice(this.candles[EUR_FIGI]);\n  }\n\n  allInstruments (): Instrument[] {\n    const figi = new Map<string, Instrument>();\n    for (const op of this.ops) {\n      if (NoFigiOps.has(op.operationType)) {\n        continue;\n      }\n\n      if (op.figi === undefined) {\n        console.log(\"Weird op figi\", op);\n        continue;\n      }\n\n      if (op.figi === USD_FIGI || op.figi === EUR_FIGI) continue;\n\n      if (!figi.has(op.figi)) {\n        const i = this.instrumentsMap[op.figi];\n\n        if (i === undefined) {\n          console.log(\"Unknown op figi\", op);\n          continue;\n        }\n\n        figi.set(op.figi, i);\n      }\n    }\n\n    return [...figi.values()];\n  }\n\n  timeline (): DayStats[] {\n    const dayStats: DayStats[] = [];\n\n    const stats: Omit<DayStats, \"date\" | \"portfolio\" | \"instrumentsCosts\" | \"ops\" | \"usdPrice\" | \"eurPrice\"> = {\n      rub: 0,\n      usd: 0,\n      eur: 0,\n\n      ownRub: 0,\n      ownUsd: 0,\n      ownEur: 0,\n    };\n\n    const portfolio: {\n      [figi: string]: InstrumentState;\n    } = {};\n\n    let opIndex = 0;\n\n    for (let d = startDay(new Date(this.ops[0].date)); d < nextDay(new Date()); d = nextDay(d)) {\n      const nd = nextDay(d);\n\n      const ops: Operation[] = [];\n\n      while (true) {\n        const op = this.ops[opIndex];\n\n        if (op === undefined || new Date(op.date) >= nd) {\n          break;\n        }\n\n        opIndex++;\n\n        if (op.status !== \"Done\") {\n          continue;\n        }\n\n        stats[op.currency.toLowerCase() as \"rub\" | \"usd\" | \"eur\"] += op.payment;\n\n        const { figi } = op;\n        const quantity = opQuantity(op);\n\n        if (op.operationType === \"Buy\" || op.operationType === \"BuyCard\") {\n          if (figi === undefined) {\n            throw Error(\"undefined in op figi\");\n          }\n\n          if (quantity === undefined) {\n            throw Error(\"undefined in op quantity\");\n          }\n\n          if (figi === USD_FIGI) {\n            stats.usd += quantity;\n          } else if (figi === EUR_FIGI) {\n            stats.eur += quantity;\n          } else if (portfolio[figi] === undefined) {\n            const currency = this.instrumentsMap[figi]?.currency;\n\n            if (currency === undefined) throw Error(\"Unknown instrument\");\n\n            portfolio[figi] = {\n              figi,\n              amount: quantity,\n              price: -1,\n              currency,\n              ops: [op]\n            };\n          } else {\n            portfolio[figi].amount += quantity;\n            portfolio[figi].ops.push(op);\n          }\n        }\n\n        if (op.operationType === \"Sell\") {\n          if (figi === undefined) {\n            throw Error(\"undefined in op figi\");\n          }\n\n          if (quantity === undefined) {\n            throw Error(\"undefined in op quantity\");\n          }\n\n          if (figi === USD_FIGI) {\n            stats.usd -= quantity;\n          } else if (figi === EUR_FIGI) {\n            stats.eur -= quantity;\n          } else if (portfolio[figi] === undefined) {\n            const currency = this.instrumentsMap[figi]?.currency;\n\n            if (currency === undefined) throw Error(\"Unknown instrument\");\n\n            portfolio[figi] = {\n              figi,\n              amount: -quantity,\n              price: -1,\n              currency,\n              ops: [op]\n            };\n          } else {\n            portfolio[figi].amount -= quantity;\n            portfolio[figi].ops.push(op);\n          }\n        }\n\n        if (op.operationType === \"PayIn\" || op.operationType === \"PayOut\") {\n          if (op.currency === \"RUB\") {\n            stats.ownRub += op.payment;\n          } else if (op.currency === \"USD\") {\n            stats.ownUsd += op.payment;\n          } else {\n            stats.ownEur += op.payment;\n          }\n        }\n\n        if (op.operationType === \"Dividend\") {\n          if (figi === undefined) {\n            throw Error(\"undefined in op figi\");\n          }\n\n          portfolio[figi].ops.push(op);\n        }\n\n        ops.push(op);\n      }\n\n      for (const i of Object.values(portfolio)) {\n        const candles = this.candles[i.figi];\n        const price = findPrice(candles, nd);\n\n        if (price === undefined) {\n          console.log(i, candles, nextDay);\n          throw Error(\"Can't find price\");\n        }\n\n        i.price = price;\n      }\n\n      const usdPrice = findPrice(this.candles[USD_FIGI], nd);\n      if (usdPrice === undefined) throw Error(\"Can't find USD price\");\n      const eurPrice = findPrice(this.candles[EUR_FIGI], nd);\n      if (eurPrice === undefined) throw Error(\"Can't find EUR price\");\n\n      dayStats.push({\n        ...stats,\n        date: d,\n        portfolio: deepCopy(portfolio),\n        ops,\n        usdPrice,\n        eurPrice\n      });\n    }\n\n    return dayStats;\n  }\n}\n\n","import { DateTime } from 'luxon';\nimport React from 'react';\nimport { Candle, loadCandles } from './api/candles';\nimport { Operation } from './api/common';\nimport { InstrumentsMap, loadInstruments } from './api/instruments';\nimport { loadOps } from './api/operations';\nimport { apiToken, clearApiToken } from './api/token';\nimport './App.scss';\nimport { HistoryBlock } from './blocks/history';\nimport { LoginForm } from './blocks/loginForm';\nimport { PortfolioBlock } from './blocks/portfolio';\nimport { TopPanelBlock } from './blocks/topPanel';\nimport { DayStats, EUR_FIGI, Stats, USD_FIGI } from './stats/stats';\n\ninterface State {\n  instrumentsMap?: InstrumentsMap;\n  ops?: Operation[];\n  candles?: { [figi: string]: Candle[] };\n  timeline?: DayStats[];\n  loading: boolean;\n  activeTab: \"PF\" | \"TL\";\n}\n\nclass App extends React.Component<{}, State> {\n  constructor(props: {}) {\n    super(props);\n\n    this.state = {\n      loading: false,\n      activeTab: \"PF\",\n    };\n  }\n\n  async componentDidMount (): Promise<void> {\n    this.loadData();\n  }\n\n  render (): JSX.Element {\n    if (apiToken() === null) {\n      return <LoginForm onLoggedIn={(): void => { this.loadData(); this.forceUpdate(); }} />;\n    }\n\n    const { instrumentsMap, timeline, activeTab } = this.state;\n\n    let usdPrice: number | undefined = undefined;\n    let eurPrice: number | undefined = undefined;\n\n    if (timeline !== undefined && timeline.length > 0) {\n      const lastDay = timeline[timeline.length - 1];\n      usdPrice = lastDay.usdPrice;\n      eurPrice = lastDay.eurPrice;\n    }\n\n    const topPanel = (\n      <TopPanelBlock\n        loading={this.state.loading}\n        activeTab={activeTab}\n        usdPrice={usdPrice}\n        eurPrice={eurPrice}\n        onTabClick={(tab): void => this.setState({ activeTab: tab })}\n        onReloadClick={(): void => { this.loadData(); }}\n        onLogoutClick={(): void => {\n          clearApiToken();\n          this.setState({ instrumentsMap: undefined, ops: undefined, candles: undefined });\n        }}\n      />\n    );\n\n    if (instrumentsMap === undefined || timeline === undefined) {\n      return (\n        <div className='cApp'>\n          {topPanel}\n          <div className='cApp-body' />\n        </div>\n      );\n    }\n\n    if (activeTab === \"PF\") {\n      return (\n        <div className='cApp'>\n          {topPanel}\n          <div className='cApp-body'>\n            <PortfolioBlock instruments={instrumentsMap} timeline={timeline} />\n          </div>\n        </div>\n      );\n    }\n\n    return (\n      <div className='cApp'>\n        {topPanel}\n        <div className='cApp-body'>\n          <HistoryBlock instruments={instrumentsMap} states={timeline} />\n        </div>\n      </div>\n    );\n  }\n\n  async loadData (): Promise<void> {\n    if (apiToken() === null) {\n      return;\n    }\n\n    this.setState({ loading: true });\n\n    try {\n      const instrumentsMap = await loadInstruments();\n      const ops = await loadOps();\n\n      const stats = new Stats(instrumentsMap, ops, {});\n      const candles: { [figi: string]: Candle[] } = {};\n      const cPromises: Promise<void>[] = [];\n      const candlesLoadFrom = DateTime.fromISO(ops[0].date).minus({ hours: 7 * 24 }).toJSDate();\n\n      for (const i of stats.allInstruments()) {\n        cPromises.push((async (): Promise<void> => {\n          const c = await loadCandles(i.figi, candlesLoadFrom);\n          candles[i.figi] = c;\n        })());\n      }\n\n      cPromises.push((async (): Promise<void> => {\n        const c = await loadCandles(USD_FIGI, candlesLoadFrom);\n        candles[USD_FIGI] = c;\n      })());\n\n      cPromises.push((async (): Promise<void> => {\n        const c = await loadCandles(EUR_FIGI, candlesLoadFrom);\n        candles[EUR_FIGI] = c;\n      })());\n\n      await Promise.all(cPromises);\n\n      const timeline = new Stats(instrumentsMap, ops, candles).timeline();\n\n      this.setState({ instrumentsMap, ops, candles, timeline });\n    } finally {\n      this.setState({ loading: false });\n    }\n  }\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      process.env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' }\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(<App />, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}